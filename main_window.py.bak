# gui.py
from qtpy.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QHBoxLayout,QGroupBox,QProgressBar,
    QPushButton, QLineEdit, QLabel, QFileDialog, QTextEdit,QTableWidget, QTableWidgetItem
)
from qtpy.QtGui import QFont
import html
import pandas as pd
from qtpy.QtCore import Qt
import sys
###yaml
import yaml
from pygments import highlight
from pygments.lexers import YamlLexer
from pygments.formatters import HtmlFormatter
from pygments.styles import get_style_by_name

# æ¨èæŸ”å’Œé£æ ¼ï¼š'friendly', 'colorful', 'vs', 'trac'
STYLE = 'friendly'  # è¯•è¯• 'vs' æˆ– 'colorful' çœ‹ä½ å–œæ¬¢å“ªä¸ª


from core.engine import BatchProcessor
from config.loader import load_config, generate_template   #AVAILABLE_PROCESSORS, 
from processors.processor import ProcessingContext,PROCESSORS,PRE_PROCESSORS,POST_PROCESSORS

from qtpy.QtGui import QTextCharFormat, QSyntaxHighlighter

class YamlHighlighter(QSyntaxHighlighter):
    def __init__(self, parent):
        super().__init__(parent)
        self._formats = {}

        # ç®€å•æ ¼å¼
        keyword_format = QTextCharFormat()
        keyword_format.setForeground(Qt.blue)
        keyword_format.setFontWeight(QFont.Bold)
        self._formats['keyword'] = keyword_format

        string_format = QTextCharFormat()
        string_format.setForeground(Qt.darkGreen)
        self._formats['string'] = string_format

    def highlightBlock(self, text):
        import re
        # åŒ¹é… key:
        for match in re.finditer(r'\b\w+(?=:)', text):
            self.setFormat(match.start(), match.end() - match.start(), self._formats['keyword'])
        # åŒ¹é…å­—ç¬¦ä¸²
        for match in re.finditer(r'"[^"]*"', text):
            self.setFormat(match.start(), match.end() - match.start(), self._formats['string'])
        for match in re.finditer(r"'[^']*'", text):
            self.setFormat(match.start(), match.end() - match.start(), self._formats['string'])



class BatchProcessorGUI(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("æ‰¹å¤„ç†ç³»ç»Ÿ")
        self.resize(600, 400)
        self.config_path = ""
        self.root_path = ""

        layout = QVBoxLayout()

        # è·¯å¾„é€‰æ‹©
        self._add_path_row(layout, "é…ç½®æ–‡ä»¶:", self._browse_config, "config_line")
        self._add_path_row(layout, "ç›®æ ‡ç›®å½•:", self._browse_root, "root_line")
        self._add_path_row(layout, "æ’ä»¶ç›®å½•:", self._browse_plugins, "plugins_line")  # ğŸ‘ˆ æ–°å¢

        # æŒ‰é’®
        btn_layout = QHBoxLayout()
        btn_load = QPushButton("åŠ è½½é…ç½®")
        btn_load.clicked.connect(self._load_config)
        btn_run = QPushButton("å¼€å§‹å¤„ç†")
        btn_run.clicked.connect(self._run)
        btn_template = QPushButton("ç”Ÿæˆæ¨¡æ¿")
        btn_template.clicked.connect(self._gen_template)
        btn_plugins = QPushButton("ğŸ”Œ åŠ è½½æ’ä»¶")
        btn_plugins.clicked.connect(self._load_plugins)
        btn_layout.addWidget(btn_load)
        btn_layout.addWidget(btn_run)
        btn_layout.addWidget(btn_template)
        btn_layout.addWidget(btn_plugins)
        layout.addLayout(btn_layout)
        btn_edit_config = QPushButton("ğŸ“ ç¼–è¾‘é…ç½®")
        btn_edit_config.clicked.connect(self._open_config_editor)
        btn_layout.addWidget(btn_edit_config)
        # åœ¨ btn_edit_config ä¹‹åæ·»åŠ 
        btn_save = QPushButton("ğŸ’¾ ä¿å­˜é…ç½®")
        btn_save.clicked.connect(self._save_config_file)
        btn_layout.addWidget(btn_save)
        # æ·»åŠ æŒ‰é’®
        btn_format = QPushButton("âœ¨ æ ¼å¼åŒ–")
        btn_format.clicked.connect(self._format_config)
        btn_layout.addWidget(btn_format)
                
        # === æ’ä»¶ç®¡ç†è¡¨æ ¼ ===
        layout.addWidget(QLabel("ğŸ“¦ å·²åŠ è½½æ’ä»¶:"))
        
        self.plugin_table = QTableWidget()
        self.plugin_table.setColumnCount(7)  # ä» 6 æ”¹æˆ 7
        self.plugin_table.setHorizontalHeaderLabels(["æ–‡ä»¶", "å¯ç”¨", "å¤„ç†å™¨", "ç±»å‹", "ä¼˜å…ˆçº§", "ä½œè€…", "ç‰ˆæœ¬"])
        self.plugin_table.verticalHeader().setVisible(False)
        self.plugin_table.setSelectionBehavior(QTableWidget.SelectRows)
        self.plugin_table.cellClicked.connect(self._on_plugin_selected)
        layout.addWidget(self.plugin_table)
    
        # === æ’ä»¶è¯´æ˜é¢„è§ˆ ===
        layout.addWidget(QLabel("ğŸ“Œ æ’ä»¶è¯´æ˜:"))
        self.plugin_info = QTextEdit()
        self.plugin_info.setReadOnly(True)
        self.plugin_info.setMaximumHeight(120)
        layout.addWidget(self.plugin_info)

        # === é…ç½®æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ ============
        config_group = QGroupBox("é…ç½®æ–‡ä»¶ (config.yaml)")
        config_layout = QVBoxLayout()

        # ä½¿ç”¨ QTextEdit æ˜¾ç¤º YAMLï¼Œæ”¯æŒé«˜äº®
        self.config_textedit = QTextEdit()
        self.config_textedit.setAcceptRichText(False)  # â—å…³é”®ï¼šç¦ç”¨å¯Œæ–‡æœ¬
        self.config_textedit.setFont(QFont("Consolas", 10))
        self.config_textedit.setLineWrapMode(QTextEdit.NoWrap)
        # å¯é€‰ï¼šè®¾ç½®ç­‰å®½å­—ä½“èƒŒæ™¯è‰²
        self.config_textedit.setStyleSheet("QTextEdit { background: #f3f3f3; }")
        self.highlighter = YamlHighlighter(self.config_textedit.document())    ##è¯­æ³•é«˜äº®
        config_layout.addWidget(self.config_textedit)
        config_group.setLayout(config_layout)
        layout.addWidget(config_group)


        # è¿›åº¦æ¡
        self.progress_bar = QProgressBar()
        self.progress_bar.setValue(0)
        self.progress_bar.setFormat("å‡†å¤‡ä¸­...")
        layout.addWidget(QLabel("è¿›åº¦:"))
        layout.addWidget(self.progress_bar)

        # æ—¥å¿—è¾“å‡º
        self.log = QTextEdit()
        self.log.setReadOnly(True)
        layout.addWidget(QLabel("æ—¥å¿—:"))
        layout.addWidget(self.log)

        self.setLayout(layout)

    def _add_path_row(self, parent, label, browse_func, line_attr):
        row = QHBoxLayout()
        row.addWidget(QLabel(label))
        line = QLineEdit()
        setattr(self, line_attr, line)
        row.addWidget(line)
        btn = QPushButton("...")
        btn.clicked.connect(browse_func)
        row.addWidget(btn)
        parent.addLayout(row)

    def _browse_config(self):
        path, _ = QFileDialog.getOpenFileName(self, "é€‰æ‹©é…ç½®æ–‡ä»¶", "", "Config Files (*.json *.yaml *.yml)")
        if path:
            self.config_line.setText(path)
            self.config_path = path

    def _browse_root(self):
        path = QFileDialog.getExistingDirectory(self, "é€‰æ‹©ç›®æ ‡ç›®å½•")
        if path:
            self.root_line.setText(path)
            self.root_path = path

    def _browse_plugins(self):
        path = QFileDialog.getExistingDirectory(self, "é€‰æ‹©æ’ä»¶ç›®å½•")
        if path:
            self.plugins_line.setText(path)

    def _load_config(self):
        if not self.config_path:
            self.config_path = self.config_line.text().strip()
        if not self.config_path:
            self._log("è¯·å…ˆé€‰æ‹©é…ç½®æ–‡ä»¶")
            return
    
        try:
            self.config = load_config(self.config_path)
    
            # æŠŠ config è½¬å›æ ¼å¼åŒ–çš„ YAML å­—ç¬¦ä¸²
            yaml_str = yaml.dump(
                self.config,
                default_flow_style=False,
                allow_unicode=True,
                indent=2,
                sort_keys=False  # ä¿æŒåŸå§‹é¡ºåº
            )
    
            # ä½¿ç”¨ Pygments é«˜äº®
#            html_code = highlight(
#                yaml_str,
#                YamlLexer(),
#                HtmlFormatter(style=STYLE)
#            )
#    
#            # è·å– CSS æ ·å¼ + é«˜äº®ä»£ç 
#            css = HtmlFormatter(style=STYLE).get_style_defs('.highlight')
#            full_html = f"<style>{css}</style><div class='highlight'><pre>{html_code}</pre></div>"
#    
#            # è®¾ç½®ä¸ºå¯Œæ–‡æœ¬
#            self.config_textedit.setHtml(full_html)
            
            self.config_textedit.setPlainText(yaml_str)  # âœ… çº¯æ–‡æœ¬
    
            self._log(f"âœ… é…ç½®åŠ è½½æˆåŠŸ: {list(self.config.keys())}")
        except Exception as e:
            self._log(f"âŒ åŠ è½½å¤±è´¥: {e}")
   #
   #æ ¼å¼åŒ–
    def _format_config(self):
        yaml_text = self.config_textedit.toPlainText().strip()
        if not yaml_text:
            return
    
        try:
            data = yaml.safe_load(yaml_text)
            formatted = yaml.dump(
                data,
                default_flow_style=False,
                allow_unicode=True,
                indent=2,
                sort_keys=False
            )
            self.config_textedit.setPlainText(formatted)
            self._log("âœ… é…ç½®å·²æ ¼å¼åŒ–")
        except yaml.YAMLError as e:
            self._log(f"âŒ æ— æ³•æ ¼å¼åŒ–ï¼Œè¯­æ³•é”™è¯¯: ç¬¬ {e.problem_mark.line + 1} è¡Œ")

    ##ä¿å­˜ç¼–è¾‘å®Œæˆçš„é…ç½®æ–‡ä»¶
    def _save_config_file(self):
        if not self.config_path:
            self.config_path = self.config_line.text().strip()
        if not self.config_path:
            self._log("âŒ è¯·å…ˆåŠ è½½æˆ–é€‰æ‹©é…ç½®æ–‡ä»¶")
            return
    
        # è·å–æ–‡æœ¬å†…å®¹
        yaml_text = self.config_textedit.toPlainText().strip()
        if not yaml_text:
            self._log("âŒ é…ç½®å†…å®¹ä¸ºç©º")
            return
    
        try:
            # âœ… 1. è§£æ YAMLï¼ŒéªŒè¯è¯­æ³•
            new_config = yaml.safe_load(yaml_text)
            if not isinstance(new_config, dict):
                raise ValueError("é…ç½®å¿…é¡»æ˜¯ä¸€ä¸ªå¯¹è±¡")
    
            # âœ… 2. å†™å…¥æ–‡ä»¶
            with open(self.config_path, 'w', encoding='utf-8') as f:
                f.write(yaml_text)
    
            # âœ… 3. æ›´æ–°å†…å­˜ä¸­çš„ config
            self.config = new_config
    
            self._log(f"âœ… é…ç½®å·²ä¿å­˜: {self.config_path}")
            self._log(f"ğŸ”„ å·²é‡æ–°åŠ è½½é…ç½®")
    
        except yaml.YAMLError as e:
            self._log(f"âŒ YAML è¯­æ³•é”™è¯¯: ç¬¬ {e.problem_mark.line + 1} è¡Œ")
            self._log(f"   {e.problem}")
        except Exception as e:
            self._log(f"âŒ ä¿å­˜å¤±è´¥: {e}")


    def _run(self):
        if not hasattr(self, 'config'):
            self._load_config()
        if not hasattr(self, 'config'):
            return
        if not self.root_path:
            self.root_path = self.root_line.text().strip()
        if not self.root_path:
            self._log("è¯·æŒ‡å®šç›®æ ‡ç›®å½•")
            return

        try:
            processor = BatchProcessor(self.config)   #, AVAILABLE_PROCESSORS
           # è®¾ç½®è¿›åº¦å›è°ƒ
            def progress_callback(current, total, status="å¤„ç†ä¸­"):
                self.progress_bar.setMaximum(total)
                self.progress_bar.setValue(current)
                self.progress_bar.setFormat(f"{status} [{current}/{total}]")
    
            processor.set_progress_callback(progress_callback)
    
            # é‡å®šå‘æ—¥å¿—
            import sys
            from io import StringIO
            old_stdout = sys.stdout
            sys.stdout = captured_output = StringIO()
    
            processor.run(self.root_path)
    
            sys.stdout = old_stdout
            self._log(captured_output.getvalue())
            self.progress_bar.setFormat("å®Œæˆ")
            self._show_results(processor.context.results)  # æ˜¾ç¤ºç»“æœ
        except Exception as e:
            self._log(f"âŒ è¿è¡Œå¤±è´¥: {e}")
        
        self._show_results(processor.context.results)

    def _gen_template(self):
        path, _ = QFileDialog.getSaveFileName(
            self, "ä¿å­˜æ¨¡æ¿", "config.yaml", "YAML (*.yaml);;JSON (*.json)"
        )
        if path:
            generate_template(path)
            self._log(f"âœ… æ¨¡æ¿å·²ç”Ÿæˆ: {path}")

    def _log(self, text: str):
        self.log.append(text.replace('\n', '<br>'))

     ##æ‰“å¼€é…ç½®æ–‡ä»¶
    def _open_config_editor(self):
        """æ‰“å¼€å›¾å½¢åŒ–é…ç½®ç¼–è¾‘å™¨"""
        from qtpy.QtWidgets import QDialog, QFormLayout, QLineEdit, QDialogButtonBox
    
        dialog = QDialog(self)
        dialog.setWindowTitle("ç¼–è¾‘é…ç½®")
        dialog.resize(400, 300)
    
        layout = QFormLayout()
    
        config = getattr(self, 'config', {})
    
        self.config_fields = {}
    
        for key in ['pre_process', 'post_process', 'processor']:
            line = QLineEdit(config.get(key, ""))
            self.config_fields[key] = line
            layout.addRow(key, line)
    
        # åŒ…å« filters ç­‰å¤æ‚å­—æ®µå¯æ‰©å±•ä¸ºå­å¯¹è¯æ¡†
    
        buttons = QDialogButtonBox(
            QDialogButtonBox.Ok | QDialogButtonBox.Cancel
        )
        buttons.accepted.connect(lambda: self._save_config_from_editor(dialog))
        buttons.rejected.connect(dialog.reject)
        layout.addWidget(buttons)
    
        dialog.setLayout(layout)
        dialog.exec_()
    
    def _save_config_from_editor(self, dialog):
        new_config = {}
        for key, line in self.config_fields.items():
            value = line.text().strip()
            if value:
                new_config[key] = value
            else:
                new_config[key] = None  # æˆ–è·³è¿‡
    
        self.config = new_config
        self.config_textedit.setPlainText(str(new_config))
        self._log("âœ… é…ç½®å·²æ›´æ–°")
        dialog.accept()


    def _show_results(self, results: list):
        """å°†ç»“æœåˆ—è¡¨è½¬ä¸ºè¡¨æ ¼å±•ç¤º"""
        if not results:
            return
    
        df = pd.DataFrame(results)
        df = df.fillna("")
    
        # æ¸…é™¤æ—§è¡¨æ ¼ï¼ˆå¯é€‰ï¼‰
        if hasattr(self, 'results_table'):
            self.layout().removeWidget(self.results_table)
            self.results_table.deleteLater()
    
        # åˆ›å»ºæ–°è¡¨æ ¼
        self.results_table = QTableWidget()
        self.results_table.setRowCount(len(df))
        self.results_table.setColumnCount(len(df.columns))
        self.results_table.setHorizontalHeaderLabels(df.columns)
        self.results_table.verticalHeader().setVisible(False)
    
        for i, row in df.iterrows():
            for j, val in enumerate(row):
                self.results_table.setItem(i, j, QTableWidgetItem(str(val)))
    
        # æ·»åŠ åˆ°å¸ƒå±€
        self.layout().addWidget(QLabel("ğŸ“Š å¤„ç†ç»“æœ:"))
        self.layout().addWidget(self.results_table)



    def _show_dataframe(self, df: pd.DataFrame):
        self.table = QTableWidget()
        self.table.setRowCount(len(df))
        self.table.setColumnCount(len(df.columns))
        self.table.setHorizontalHeaderLabels(df.columns)
        
        for i, row in df.iterrows():
            for j, val in enumerate(row):
                self.table.setItem(i, j, QTableWidgetItem(str(val)))
        
        self.layout.addWidget(self.table)

    def _load_plugins(self):
        from pathlib import Path
        from importlib.util import spec_from_file_location, module_from_spec
        import sys
    
        plugin_path = self.plugins_line.text().strip()
        if not plugin_path:
            self._log("âš ï¸ è¯·å…ˆé€‰æ‹©æ’ä»¶ç›®å½•")
            return
    
        plugin_dir = Path(plugin_path)
        if not plugin_dir.exists():
            self._log(f"âŒ æ’ä»¶ç›®å½•ä¸å­˜åœ¨: {plugin_dir}")
            return
        if not plugin_dir.is_dir():
            self._log(f"âŒ ä¸æ˜¯æœ‰æ•ˆç›®å½•: {plugin_dir}")
            return
    
        self._log(f"ğŸ” æ‰«ææ’ä»¶ç›®å½•: <b>{plugin_dir.resolve()}</b>")
    
        # æ¸…ç©ºæ—§è¡¨
        self.plugin_table.setRowCount(0)
        self.plugin_table.clearContents()
    
        loaded = 0
        failed = 0
    
        # å­˜å‚¨æ’ä»¶ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        self.loaded_plugins = {}
    
        for pyfile in plugin_dir.glob("*.py"):
            if pyfile.name == "__init__.py":
                continue
    
            try:
                module_name = f"plugin_ext_{pyfile.stem}"
                spec = spec_from_file_location(module_name, pyfile)
                module = module_from_spec(spec)
                sys.modules[module_name] = module
                spec.loader.exec_module(module)
    
                # æ‰«ææ¨¡å—ä¸­æ‰€æœ‰å¸¦ .processor_name çš„å‡½æ•°
                plugin_funcs = []
                for attr_name in dir(module):
                    attr = getattr(module, attr_name)
                    if callable(attr) and hasattr(attr, 'processor_name'):
                        
                        handler_name = attr.processor_name    ##å‡½æ•°å
                        plugin_funcs.append(attr)
                if not plugin_funcs:
                    self._log(f"ğŸŸ¡ {pyfile.name}ï¼šæœªå‘ç°å¤„ç†å™¨")
                    continue
    
                # âœ… å…³é”®ï¼šå°†æ¯ä¸ªå‡½æ•°æ³¨å†Œåˆ° AVAILABLE_PROCESSORS
                for func in plugin_funcs:
                    handler_name = func.processor_name
                   # âœ… ç»Ÿä¸€æ³¨å†Œåˆ° AVAILABLE_PROCESSORSï¼ˆä¾›é…ç½®æŸ¥æ‰¾ï¼‰
                    AVAILABLE_PROCESSORS[handler_name] = attr
                 
                    # âœ… åŒæ—¶æŒ‰ç§ç±»æ”¾å…¥ä¸“ç”¨æ³¨å†Œè¡¨ï¼ˆå¯é€‰ï¼Œæ›´æ¸…æ™°ï¼‰
                    kind = getattr(func, 'processor_kind', 'file')  # é»˜è®¤ä¸º file
                    if kind == "pre":
                        PRE_PROCESSORS[handler_name] = attr
                    elif kind == "post":
                        POST_PROCESSORS[handler_name] = attr
                    else:
                        PROCESSORS[handler_name] = attr  # file/dir ç±»å‹                    
                    
                    self._log(f"ğŸ”§ æ³¨å†Œå¤„ç†å™¨: {handler_name} <- {pyfile.name}")
    
                # è®°å½•å·²åŠ è½½æ’ä»¶ï¼ˆç”¨äº UI ç®¡ç†ï¼‰
                self.loaded_plugins[pyfile.name] = {
                    'module': module,
                    'functions': plugin_funcs
                }
    
                # æ·»åŠ åˆ°è¡¨æ ¼
                for func in plugin_funcs:
                    row = self.plugin_table.rowCount()
                    self.plugin_table.insertRow(row)
    
                    # æ–‡ä»¶å
                    self.plugin_table.setItem(row, 0, QTableWidgetItem(pyfile.name))
    
                    # å¯ç”¨å¤é€‰æ¡†
                    cb = QTableWidgetItem()
                    cb.setCheckState(Qt.Checked)
                    cb.plugin_func = func  # ç»‘å®šå‡½æ•°å¯¹è±¡
                    self.plugin_table.setItem(row, 1, cb)
    
                    # å¤„ç†å™¨å
                    self.plugin_table.setItem(row, 2, QTableWidgetItem(func.processor_name))

                   # ğŸ”” ç±»å‹ï¼ˆæ–°å¢ï¼‰
                    ptype = getattr(func, 'processor_type', 'file')
                    type_item = QTableWidgetItem(ptype.upper())
                    if ptype == "pre":
                        type_item.setForeground(Qt.blue)
                    elif ptype == "post":
                        type_item.setForeground(Qt.magenta)
                    else:
                        type_item.setForeground(Qt.darkGreen)
                    self.plugin_table.setItem(row, 3, type_item)

                    # åœ¨ _load_plugins() ä¸­ï¼Œæ’å…¥è¡¨æ ¼çš„å¾ªç¯é‡Œ
                    priority = getattr(func, 'processor_priority', 50)  # é»˜è®¤ä¼˜å…ˆçº§ 50
                    priority_item = QTableWidgetItem(str(priority))
                    priority_item.setTextAlignment(Qt.AlignCenter)
                    self.plugin_table.setItem(row, 4, priority_item)  # æ³¨æ„ï¼šåˆ—ç´¢å¼•å˜äº†ï¼

                    # å…ƒæ•°æ®
                    meta = getattr(func, 'metadata', {})
                    self.plugin_table.setItem(row, 5, QTableWidgetItem(meta.get("author", "æœªçŸ¥")))
                    self.plugin_table.setItem(row, 6, QTableWidgetItem(meta.get("version", "-")))
    
                self._log(f"âœ… æˆåŠŸåŠ è½½æ’ä»¶: <b>{pyfile.name}</b> ({len(plugin_funcs)} ä¸ªå¤„ç†å™¨)")
                loaded += 1
    
            except Exception as e:
                self._log(f"âŒ åŠ è½½å¤±è´¥ {pyfile.name}: <span style='color:red;'>{e}</span>")
                failed += 1
    
        # âœ… æœ€åæ‰“å° PROCESSORS å†…å®¹ç”¨äºè°ƒè¯•
        self._log(f"ğŸ“Š æ’ä»¶åŠ è½½å®Œæˆ: <b>{loaded}</b> æˆåŠŸ, <b>{failed}</b> å¤±è´¥")
        self._log(f"ğŸ”„ å¯ç”¨å¤„ç†å™¨: {list(PROCESSORS.keys())}")
    
        # ğŸ” è°ƒè¯•ï¼šæ‰“å°ç±»å‹
        print("\nğŸ” PROCESSORS è°ƒè¯•:")
        for k, v in PROCESSORS.items():
            print(f"  {k} -> type={type(v).__name__}, callable={callable(v)}")
    
    def _on_plugin_selected(self, row, col):
        cb_item = self.plugin_table.item(row, 1)
        if not hasattr(cb_item, 'plugin_func'):
            return
    
        func = cb_item.plugin_func
        meta = getattr(func, 'metadata', {})
    
        def safe_str(value, default=""):
            return html.escape(str(value)) if value is not None else default
    
        name = safe_str(meta.get('name'), func.processor_name)
        processor_name = safe_str(func.processor_name)
        author = safe_str(meta.get('author'), "æœªçŸ¥")
        version = safe_str(meta.get('version'), "N/A")
        description = safe_str(meta.get('description'), "æ— ")
        supported_types = ", ".join(meta.get('supported_types', [])) or "æ— "
        tags = ", ".join(meta.get('tags', [])) or "æ— "
        priority = getattr(func, 'processor_priority', 50)
        ptype = getattr(func, 'processor_type', 'file').upper()
    
        # ğŸ”” åŠ å…¥ç±»å‹
        doc = (
            f"<b>åç§°:</b> {name}<br>\n"
            f"<b>å¤„ç†å™¨:</b> {processor_name}<br>\n"
            f"<b>ç±»å‹:</b> <span style='color: {'blue' if ptype=='PRE' else 'magenta' if ptype=='POST' else 'green'};'>{ptype}</span><br>\n"
            f"<b>ä¼˜å…ˆçº§:</b> <b>{priority}</b><br>\n"  # ğŸ‘ˆ æ–°å¢
            f"<b>ä½œè€…:</b> {author}<br>\n"
            f"<b>ç‰ˆæœ¬:</b> {version}<br>\n"
            f"<b>æè¿°:</b> {description}<br>\n"
            f"<b>æ”¯æŒç±»å‹:</b> {safe_str(supported_types)}<br>\n"
            f"<b>æ ‡ç­¾:</b> {safe_str(tags)}"
        )
    
        self.plugin_info.setHtml(doc)


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = BatchProcessorGUI()
    window.show()
    sys.exit(app.exec())