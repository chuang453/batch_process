# decorators.py
from typing import Callable, Dict, Any, List, Union
from dataclasses import dataclass,field
from pathlib import Path


# ä¸Šä¸‹æ–‡å¯¹è±¡ï¼šå‡½æ•°é—´ä¼ é€’æ•°æ®çš„â€œèƒŒåŒ…â€
@dataclass
class ProcessingContext:
    data: Dict[str, Any] = field(default_factory=dict)  # å­˜å‚¨ä»»æ„æ•°æ®
    results: List[Any] = field(default_factory=list)    # æ”¶é›†å¤„ç†ç»“æœ
    metadata: Dict[str, Any] = field(default_factory=dict)  # å…ƒä¿¡æ¯
    shared: Dict[str, Any] = field(default_factory=dict)    # å…¨å±€å…±äº«æ•°æ®

    def set_data(self, key: str, value: Any):
        self.data[key] = value

    def get_data(self, key: str, default=None):
        return self.data.get(key, default)

    def add_result(self, result: Any):
        self.results.append(result)

    def update_metadata(self, **kwargs):
        self.metadata.update(kwargs)


# å…¨å±€å¤„ç†å™¨æ³¨å†Œè¡¨
PROCESSORS: Dict[str, Callable[[Path, ProcessingContext], Any]] = {}
# æ–°å¢ï¼šå‰å¤„ç†å™¨å’Œåå¤„ç†å™¨æ³¨å†Œè¡¨
PRE_PROCESSORS: Dict[str, Callable[[ProcessingContext], Any]] = {}
POST_PROCESSORS: Dict[str, Callable[[ProcessingContext], Any]] = {}

# ç¤ºä¾‹å¤„ç†å™¨å‡½æ•°ï¼ˆä¾›é…ç½®å¼•ç”¨ï¼‰
def process_text(folder): print(f"ğŸ“„ å¤„ç†æ–‡æœ¬: {folder}")
def process_csv(folder): print(f"ğŸ“Š å¤„ç† CSV: {folder}")
def backup(file): print(f"ğŸ’¾ å¤‡ä»½: {file}")
def analyze_log(file): print(f"ğŸ” åˆ†ææ—¥å¿—: {file}")

# å‡½æ•°å â†’ å‡½æ•°å¯¹è±¡
AVAILABLE_PROCESSORS = {
    "process_text": process_text,
    "process_csv": process_text,
    "backup": backup,
    "analyze_log": analyze_log,
}




def _set_processor_attributes(
    func: Callable,
    name: str,            ##åç§°
    kind: str,            ##'pre', 'file', 'post'
    priority: int = 50,   ##ä¼˜å…ˆçº§
    type_hint: str = "file",    ##å¤„ç†æ–‡ä»¶ç±»ï¼Œå‹
    metadata: Dict[str, Any] = None
):
    """
    ç»Ÿä¸€è®¾ç½®å‡½æ•°çš„æ’ä»¶å…ƒæ•°æ®
    """
    func.processor_name = name
    func.processor_kind = kind           # 'pre', 'file', 'post'
    func.processor_priority = priority   # æ•´æ•°ï¼Œç”¨äºæ’åº
    func.processor_type = type_hint      # å¦‚ 'file', 'dir', 'image' ç­‰ï¼ˆå¯é€‰ï¼‰
    func.metadata = metadata or {}
    return func

###æ³¨å†Œçš„å‡½æ•°åä¼˜å…ˆåä¸º name, ä¼˜å…ˆçº§priority
## æ‰€æœ‰ç”¨æ­¤è£…é¥°å™¨çš„å¤„ç†å‡½æ•°éƒ½ä¼šè¢«æ³¨å†Œåˆ°PROCESSORSä¸­
def processor(name: str = None, priority: int = 50, type: str = "file", metadata: dict = None):
    """
    è£…é¥°å™¨ï¼šæ³¨å†Œä¸€ä¸ªæ–‡ä»¶/ç›®å½•å¤„ç†å™¨

    ç¤ºä¾‹ï¼š
        @processor(name="resize_images", priority=60, type="image", metadata={
            "name": "å›¾åƒç¼©æ”¾",
            "author": "Alice",
            "version": "1.0",
            "description": "å°†å›¾ç‰‡ç»Ÿä¸€ç¼©æ”¾åˆ°æŒ‡å®šå°ºå¯¸",
            "supported_types": ["jpg", "png"],
            "tags": ["image", "resize"]
        })
        def resize_images(file_path, context):
            ...
    """
    def decorator(func):
        proc_name = name or func.__name__
        if proc_name in PROCESSORS:
            raise ValueError(f"å¤„ç†å™¨å·²å­˜åœ¨: {proc_name}")
        func = _set_processor_attributes(func, proc_name, "file", priority, type, metadata)
        PROCESSORS[proc_name] = func
        AVAILABLE_PROCESSORS[proc_name] = func 
        return func
    return decorator

# ä½¿ç”¨æ—¶åªéœ€ @processor
#@processor(name="backup_file", type="file", priority=10)
#def backup_file(file_path, context, backup_dir="./backup/"):
    # ...


def pre_processor(name: str = None, priority: int = 50, metadata: dict = None):
    """
    è£…é¥°å™¨ï¼šæ³¨å†Œä¸€ä¸ªé¢„å¤„ç†å™¨ï¼ˆåœ¨éå†å‰æ‰§è¡Œï¼‰

    ç¤ºä¾‹ï¼š
        @pre_processor(name="backup_dir", priority=10)
        def backup_before_processing(root_path, context):
            ...
    """
    def decorator(func):
        proc_name = name or func.__name__
        if proc_name in PRE_PROCESSORS:
            raise ValueError(f"é¢„å¤„ç†å™¨å·²å­˜åœ¨: {proc_name}")

        func = _set_processor_attributes(func, proc_name, "pre", priority, "pre", metadata)
        PRE_PROCESSORS[proc_name] = func
        AVAILABLE_PROCESSORS[proc_name] = func
        return func
    return decorator

def post_processor(name: str = None, priority: int = 50, metadata: dict = None):
    """
    è£…é¥°å™¨ï¼šæ³¨å†Œä¸€ä¸ªåå¤„ç†å™¨ï¼ˆåœ¨æ‰€æœ‰æ–‡ä»¶å¤„ç†åæ‰§è¡Œï¼‰

    ç¤ºä¾‹ï¼š
        @post_processor(name="generate_report", priority=90)
        def generate_summary_report(root_path, context):
            ...
    """
    def decorator(func):
        proc_name = name or func.__name__
        if proc_name in POST_PROCESSORS:
            raise ValueError(f"åå¤„ç†å™¨å·²å­˜åœ¨: {proc_name}")

        func = _set_processor_attributes(func, proc_name, "post", priority, "post", metadata)
        POST_PROCESSORS[proc_name] = func
        AVAILABLE_PROCESSORS[proc_name] = func
        return func
    return decorator

# âœ… è¾…åŠ©å‡½æ•°ï¼šè·å–æ‰€æœ‰å·²æ³¨å†Œå¤„ç†å™¨ä¿¡æ¯ï¼ˆå¯ç”¨äºè°ƒè¯•æˆ–ç”Ÿæˆæ–‡æ¡£ï¼‰
def get_all_processors():
    """è¿”å›æ‰€æœ‰æ³¨å†Œçš„å¤„ç†å™¨ä¿¡æ¯åˆ—è¡¨"""
    result = []
    for reg, kind in [
        (PRE_PROCESSORS, "pre"),
        (PROCESSORS, "file"),
        (POST_PROCESSORS, "post")
    ]:
        for name, func in reg.items():
            result.append({
                "name": name,
                "kind": kind,
                "priority": getattr(func, "processor_priority", 50),
                "type": getattr(func, "processor_type", ""),
                "metadata": getattr(func, "metadata", {}),
                "func": func
            })
    return sorted(result, key=lambda x: (["pre", "file", "post"].index(x["kind"]), x["priority"]))





##å…¶ä»–åŠŸèƒ½è£…é¥°å™¨
# decorators.py
import time
from functools import wraps
##å¤±è´¥é‡è¯•è£…é¥°å™¨ã€‚é€šå¸¸ä¸@processorååŒä½¿ç”¨ã€‚æä¾›å®¹é”™
'''
ğŸ” è‡ªåŠ¨é‡è¯•	å‡½æ•°å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•æœ€å¤š max_attempts æ¬¡
â³ æŒ‡æ•°é€€é¿	æ¯æ¬¡ç­‰å¾…æ—¶é—´ç¿»å€ï¼ˆdelay * backoffï¼‰
ğŸ“ ç»“æ„åŒ–é”™è¯¯è¿”å›	å¤±è´¥åè¿”å›ä¸€ä¸ªé”™è¯¯è®°å½•ï¼Œè€Œä¸æ˜¯æŠ›å¼‚å¸¸ï¼ˆé¿å…ä¸­æ–­æ•´ä¸ªæ‰¹å¤„ç†ï¼‰
ğŸ’¬ æ—¥å¿—è¾“å‡º	æ‰“å°é‡è¯•ä¿¡æ¯ï¼Œä¾¿äºç›‘æ§


'''
def retry(max_attempts: int = 3, delay: float = 1.0, backoff: float = 2.0):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            attempts = 0
            current_delay = delay
            last_error = None
            
            while attempts < max_attempts:
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    attempts += 1
                    last_error = e
                    if attempts >= max_attempts:
                        break
                    print(f"ğŸ” {func.__name__} å¤±è´¥ï¼Œ{current_delay:.1f}s åé‡è¯• ({attempts}/{max_attempts})")
                    time.sleep(current_delay)
                    current_delay *= backoff
            
            print(f"âŒ {func.__name__} æœ€ç»ˆå¤±è´¥: {last_error}")
            # è¿”å›é”™è¯¯è®°å½•
            if args and len(args) >= 2:
                path = args[0]
                return {
                    "file": str(path),
                    "processor": getattr(func, 'processor_name', func.__name__),
                    "status": "failed",
                    "error": str(last_error),
                    "attempt": attempts
                }
            raise last_error
        return wrapper
    return decorator

# ä½¿ç”¨ï¼šå…ˆè£…é¥°ä¸ºå¯é‡è¯•å‡½æ•°ï¼Œå†è£…é¥°ä¸ºprocessor
@processor("download_file")
@retry(max_attempts=3, delay=2)
def download_file(url: Path, context: ProcessingContext):
    # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
    pass